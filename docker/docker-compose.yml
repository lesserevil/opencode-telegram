services:
  telegramcoder:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: telegramcoder
    restart: unless-stopped

    # Environment file
    env_file:
      - .env

    # Volumes for persistent data
    volumes:
      # Logs directory - persists bot logs
      - ../logs:/app/logs

      # Events directory - persists event snapshots
      - ../events:/app/events

      # Workspace directory - OpenCode workspace
      - opencode_workspace:/workspace

      # Optional: Mount local .env file
      # - ../.env:/app/.env:ro

    # Ports
    ports:
      - "4000:4000"  # OpenCode server port

    # Resource limits - adjust based on your server capacity
    deploy:
      resources:
        limits:
          cpus: "4.0"      # Maximum 4 CPU cores
          memory: 4G       # Maximum 4GB RAM
        reservations:
          cpus: "0.5"      # Minimum 0.5 CPU cores
          memory: 512M     # Minimum 512MB RAM

    # Security options
    security_opt:
      - no-new-privileges:true

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

# Named volumes
volumes:
  opencode_workspace:
    driver: local
